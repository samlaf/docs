<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="search" type="application/opensearchdescription+xml" title="Flashbots Docs" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">codebase - deep dive | Flashbots Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.flashbots.net/flashbots-data/deprecated/mev-inspect-rs/inspect-codebase-deep-dive"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="codebase - deep dive | Flashbots Docs"><meta data-react-helmet="true" name="description" content="A deep dive into the codebase, particularly for those who are looking to get familiar with both Rust and the inspect codebase"><meta data-react-helmet="true" property="og:description" content="A deep dive into the codebase, particularly for those who are looking to get familiar with both Rust and the inspect codebase"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.flashbots.net/flashbots-data/deprecated/mev-inspect-rs/inspect-codebase-deep-dive"><link data-react-helmet="true" rel="alternate" href="https://docs.flashbots.net/flashbots-data/deprecated/mev-inspect-rs/inspect-codebase-deep-dive" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.flashbots.net/flashbots-data/deprecated/mev-inspect-rs/inspect-codebase-deep-dive" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.fcd70796.css">
<link rel="preload" href="/assets/js/runtime~main.473e0d4c.js" as="script">
<link rel="preload" href="/assets/js/main.f3084b14.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Flashbots Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="Flashbots Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Flashbots Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/flashbots/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>codebase - deep dive</h1></header><p>A deep dive into the codebase, particularly for those who are looking to get familiar with both Rust and the inspect codebase</p><p><em>Notes courtesy of Will Drevo, <a href="https://github.com/worldveil/mev-inspect-rs/blob/master/NOTES.md" target="_blank" rel="noopener noreferrer">source</a></em></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="mainrs"></a><code>main.rs</code><a class="hash-link" href="#mainrs" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="main"></a><code>main()</code><a class="hash-link" href="#main" title="Direct link to heading">#</a></h3><p>This is where the execution begins, in the <code>main()</code> function. Note it is an async function, which returns a Future. <a href="https://rust-lang.github.io/async-book/01_getting_started/04_async_await_primer.html" target="_blank" rel="noopener noreferrer">Read more here</a>.</p><p>The <a href="https://docs.rs/gumdrop/0.5.0/gumdrop/trait.Options.html" target="_blank" rel="noopener noreferrer">gumdrop::Options</a> package (crate) is used for command line option parsing. The order of arguments here matters:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># will work</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">./target/release/mev-inspect -u http://localhost:8080 tx 0xa72072f5041bcde89c560ba12cc00b22a87779ee369dbff81a78bba26d35e989</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># won&#x27;t parse url</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">./target/release/mev-inspect tx 0xa72072f5041bcde89c560ba12cc00b22a87779ee369dbff81a78bba26d35e989 -u http://localhost:8080</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># will return &quot;unrecognized option `-u`&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We parse the arguments with <code>Opts::parse_args_default_or_exit()</code>. Next we want to retrieve a tx from a provider (ETH node), but we want to check if it&#x27;s in the cache.</p><p>We use this line <code>let Some(ref cache) = opts.cache</code> to test for this. <code>opts.cache</code> is an <code>Option&lt;PathBuf&gt;</code>, meaning it either has no value (null), or is a <code>PathBuf</code>. <code>Some(&amp;Option&lt;PathBuf&gt;)</code> returns true if the reference is non-null. Additionally, these two are the same:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// using ref operator</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let Some(ref cache) = opts.cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// is identical to</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let Some(cache) = &amp;opts.cache</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then we create a provider, either the <a href="https://docs.rs/ethers-providers/0.2.2/ethers_providers/struct.Provider.html" target="_blank" rel="noopener noreferrer">ethers::providers::Provider</a>, or the cached version, which reads from disk.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="run"></a><code>run()</code><a class="hash-link" href="#run" title="Direct link to heading">#</a></h3><p>This is a complex function definition:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">async fn run&lt;M: Middleware + Clone + &#x27;static&gt;(provider: M, opts: Opts) -&gt; anyhow::Result&lt;()&gt; { ... }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>takes the provider &amp; options as input</li><li>returns an <a href="https://docs.rs/anyhow/1.0.0/anyhow/type.Result.html" target="_blank" rel="noopener noreferrer">anyhow:::Result</a>, which is some nice syntactic sugar around catching and printing context and a backtrace if something goes wrong. See <a href="https://docs.rs/anyhow/1.0.0/anyhow/trait.Context.html" target="_blank" rel="noopener noreferrer">here</a> specifically for how to add context inside a function.</li><li>defines a type <code>M</code> that accepts any type that implements the Middleware, Clone, and <a href="https://doc.rust-lang.org/rust-by-example/scope/lifetime/static_lifetime.html#trait-bound" target="_blank" rel="noopener noreferrer">static lifetime</a> traits. This is like an interface in Java. In our code, you can see how this was done for <code>CachedProvider</code> (src/cached_provider.rs).</li></ul><p>We wrap our provider in a reference counter <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html" target="_blank" rel="noopener noreferrer">std::styc::Arc</a>, which is the <a href="https://stackoverflow.com/a/49834496" target="_blank" rel="noopener noreferrer">C++ equvilent of std::shared_ptr</a>, inorder to prevent memory leaks.</p><p>We create a <code>mev_inspect::HistoricalPrice</code> object, giving it a provider, the price coming from Uniswap.</p><p>The inspectors are added to a vector. They are encased in <code>std::Box</code>es, which tells Rust to put these objects on the heap. This might seem silly at first (...after all, elements in a variable sized data structure like <code>Vec</code> (vector) <a href="https://stackoverflow.com/a/43642518" target="_blank" rel="noopener noreferrer">are stored in the heap</a>), but since we are using generics to hold a list of objects of a different type but all implement the same interface (ie: <code>Vec&lt;Box&lt;dyn Inspector&gt;&gt;</code>), the Box has the additional benefit of preventing the compiler from complaining about not knowing how much memory to set aside a prioi. If you remove the std::Box encasement, you&#x27;ll get:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">the size for values of type `dyn mev_inspect::Inspector` cannot be known at compilation time</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">doesn&#x27;t have a size known at compile-time</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <a href="https://doc.rust-lang.org/std/keyword.dyn.html" target="_blank" rel="noopener noreferrer"><code>dyn</code> keyword</a> isn&#x27;t strictly necessary (the compiler will make this trait dynamically dispatched), but know that it&#x27;s depcrated and you&#x27;ll get a warning.</p><p>Next we create a vector of reducers.</p><p>After that, we create a processor.</p><p>The connection between these different types seems to be:</p><ul><li><strong>Inspectors</strong> are &quot;parsers&quot; that know how a given contract is set up, and are able to extract necessary fields</li><li><strong>Reducers</strong> are &quot;checkers&quot; that examine extracted fields for different MEV actions</li><li><strong>Processor</strong> is a coordinating object that takes inspectors and parsers to inspect transactions</li></ul><p>Next we create a database connection.</p><p>Next we match on command, but if it&#x27;s a tx, we inspect.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="inspecting-a-tx"></a>Inspecting a tx<a class="hash-link" href="#inspecting-a-tx" title="Direct link to heading">#</a></h3><p>We create a <code>mev_inspect::types::Inspection</code>. This seems to choose the correct inspector and from that extracts:</p><ul><li>status (success/fail)</li><li>actions that happened, which can be any of the ones described <a href="/flashbots-data/deprecated/mev-inspect-rs/inspect-codebase-design">here</a></li><li>protocols involved</li><li>the sender, contract (if any), and proxy contract (if any) of the tx</li><li>tx hsh &amp; block height</li></ul><p>We query the provider for:</p><ul><li>the gas_used (from receipt)</li><li>the gas_price (from tx)</li></ul><p>With the inspection, gas_price, gas_used, and pricing in hand, we can coalesce into a <code>mev_inspect::types::Evaluation</code> struct which holds:</p><ul><li>the <code>mev_inspect::types::Inspection</code> object</li><li>gas_used, gas_price</li><li>actions involved</li><li>profit made!</li></ul><p>Finally, we insert the evaluation into the database.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="inspecting-a-block"></a>Inspecting a block<a class="hash-link" href="#inspecting-a-block" title="Direct link to heading">#</a></h3><p>If the command is instead for a range of blocks, we iterate through this range one by one and process the block given the usual suspects:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">process_block(&amp;mut lock, block, &amp;provider, &amp;processor, &amp;mut db, &amp;prices).await?</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="srcpricesrs"></a><code>src/prices.rs</code><a class="hash-link" href="#srcpricesrs" title="Direct link to heading">#</a></h3><p>First, generate the ABI with <a href="https://docs.rs/ethers-contract/0.1.3/ethers_contract/macro.abigen.html" target="_blank" rel="noopener noreferrer">ethers::contract::abigen</a> macro for the Uniswap contract, and store it in the <code>abi/</code> folder. This will help us decode binary data from the transactions that interact with this contract. There are many resources on this, but see <a href="https://ethereum.stackexchange.com/a/1171/34397" target="_blank" rel="noopener noreferrer">SO answer here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="sample-inspector---srcinspectorsaavers"></a>Sample inspector - <code>src/inspectors/aave.rs</code><a class="hash-link" href="#sample-inspector---srcinspectorsaavers" title="Direct link to heading">#</a></h3><p>This is the inspector for Aave.</p><p><a href="https://doc.rust-lang.org/std/keyword.impl.html" target="_blank" rel="noopener noreferrer">As is customary in Rust</a>, we define a <code>struct</code> for the data fields, and an <code>impl</code> for the methods on the object itself.</p><p>Aave inspector doesn&#x27;t need a provider because it can simply load the ABI included in the repo.</p><p>Next we implment the Inspector interface for the Aave object, which is a function that takes in a mutable inspection object that we&#x27;ll write fields to as a result of the inspection logic.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="deriving-from-traits"></a>Deriving from Traits<a class="hash-link" href="#deriving-from-traits" title="Direct link to heading">#</a></h3><p>It seems in rust that having structs derive from traits like <code>Debug</code> is universally a good idea, but there are some others to be careful of. <a href="https://users.rust-lang.org/t/what-traits-should-i-normally-derive/484/9" target="_blank" rel="noopener noreferrer">Good post on the subject here</a>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#mainrs" class="table-of-contents__link"><code>main.rs</code></a><ul><li><a href="#main" class="table-of-contents__link"><code>main()</code></a></li><li><a href="#run" class="table-of-contents__link"><code>run()</code></a></li><li><a href="#inspecting-a-tx" class="table-of-contents__link">Inspecting a tx</a></li><li><a href="#inspecting-a-block" class="table-of-contents__link">Inspecting a block</a></li><li><a href="#srcpricesrs" class="table-of-contents__link"><code>src/prices.rs</code></a></li><li><a href="#sample-inspector---srcinspectorsaavers" class="table-of-contents__link">Sample inspector - <code>src/inspectors/aave.rs</code></a></li><li><a href="#deriving-from-traits" class="table-of-contents__link">Deriving from Traits</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.473e0d4c.js"></script>
<script src="/assets/js/main.f3084b14.js"></script>
</body>
</html>